{"version":3,"sources":["LoginCanvas.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\Script\\SceneScript\\Login","sourcesContent":["import { wxLogin } from './../../Modules/JSCallNative';\r\nimport { Protocol } from './../../Modules/Protocol';\r\nconst { ccclass, property } = cc._decorator;\r\nimport * as dd from './../../Modules/ModuleManager';\r\n\r\n@ccclass\r\nexport default class LoginCanvas extends cc.Component {\r\n    /**\r\n     * 用户协议复选框\r\n     * \r\n     * @type {cc.Toggle}\r\n     * @memberof LoginCanvas\r\n     */\r\n    @property(cc.Toggle)\r\n    checkToggle: cc.Toggle = null;\r\n    /**\r\n     * 微信按钮\r\n     * \r\n     * @type {cc.Button}\r\n     * @memberof LoginCanvas\r\n     */\r\n    @property(cc.Button)\r\n    btn_wx: cc.Button = null;\r\n    /**\r\n     * 游客按钮\r\n     * \r\n     * @type {cc.Button}\r\n     * @memberof LoginCanvas\r\n     */\r\n    @property(cc.Button)\r\n    btn_yk: cc.Button = null;\r\n    /**\r\n     * 微信登录结果回调\r\n     * \r\n     * @memberof LoginCanvas\r\n     */\r\n    cb_login: (event: cc.Event.EventCustom) => void = (event: cc.Event.EventCustom) => {\r\n        dd.ui_manager.hideLoading();\r\n        let detail: CB_Login = event.detail;\r\n        if (detail.flag === 1) {//成功\r\n            let userInfo: UserInfo = detail.data as UserInfo;\r\n            userInfo.headimgurl = dd.utils.getHeadImgUrl(userInfo.headimgurl);\r\n            this.wsLogin(dd.protocol.ACCOUNT_LOGIN_WX, userInfo);\r\n        } else {//失败\r\n            dd.ui_manager.showTip(detail.data as string);\r\n        }\r\n    }\r\n    /**\r\n     * ccc组件释放的生命周期回调\r\n     * \r\n     * @memberof LoginCanvas\r\n     */\r\n    onDestroy() {\r\n        if (cc.sys.isNative && cc.sys.isMobile) {//手机端\r\n            cc.systemEvent.off('cb_login', this.cb_login, this);\r\n        }\r\n    }\r\n    async onLoad() {\r\n        dd.ui_manager.fixIPoneX(this.node);\r\n        if (dd.config.wxState === 0) {\r\n            this.btn_wx.node.active = true;\r\n            this.btn_yk.node.active = false;\r\n        } else {\r\n            this.btn_wx.node.active = false;\r\n            this.btn_yk.node.active = true;\r\n        }\r\n        if (dd.ui_manager.showLoading('正在连接服务器，请稍后')) {\r\n            let connectState = await this.connectWS();\r\n            if (cc.sys.isNative && cc.sys.isMobile && connectState) {\r\n                //注册微信登录回调\r\n                cc.systemEvent.on('cb_login', this.cb_login, this);\r\n                //微信自动登录\r\n                await this.aotuLogin();\r\n            }\r\n        }\r\n        dd.mp_manager.playBackGround();\r\n    }\r\n    /**\r\n     * 连接游戏服务器\r\n     * \r\n     * @returns {Promise<boolean>} \r\n     * @memberof LoginCanvas\r\n     */\r\n    async connectWS(): Promise<boolean> {\r\n        try {\r\n            await dd.ws_manager.connect(dd.config.wsUrl);//连接服务器\r\n            dd.ui_manager.hideLoading();\r\n            return true;\r\n        } catch (err) {\r\n            cc.log(err);\r\n            let yes: btn_obj = {\r\n                lbl_name: '确定',\r\n                callback: () => {\r\n                    this.onLoad();\r\n                }\r\n            }\r\n            dd.ui_manager.showAlert('连接服务器失败，请确认您的网络后点击确定按钮重新连接！', '错误提示', yes);\r\n            return false;\r\n        }\r\n    }\r\n    /**\r\n     * 微信自动登录\r\n     * \r\n     * @returns {Promise<void>} \r\n     * @memberof LoginCanvas\r\n     */\r\n    async aotuLogin(): Promise<void> {\r\n        let db = cc.sys.localStorage;\r\n        if (db.getItem('TokenInfo')) {//验证是否有授权过\r\n            try {\r\n                let data: TokenInfo = JSON.parse(db.getItem('TokenInfo'));\r\n                //刷新token过期时间\r\n                let url_refresh = 'https://api.weixin.qq.com/sns/oauth2/refresh_token?appid=' + dd.config.app_id + '&grant_type=refresh_token&refresh_token=' + data.refresh_token;\r\n                let response_refresh = await fetch(url_refresh);\r\n                if (response_refresh.ok) {//请求成功\r\n                    let newToken: TokenInfo = await response_refresh.json();\r\n                    db.setItem('TokenInfo', JSON.stringify(newToken));\r\n                    let url_userInfo = 'https://api.weixin.qq.com/sns/userinfo?access_token=' + newToken.access_token + '&openid=' + newToken.openid;\r\n                    let response_userInfo = await fetch(url_userInfo);\r\n                    if (response_userInfo.ok) {//获取用户信息成功\r\n                        let userInfo = await response_userInfo.json();\r\n                        userInfo.headimgurl = dd.utils.getHeadImgUrl(userInfo.headimgurl);\r\n                        this.wsLogin(dd.protocol.ACCOUNT_LOGIN_WX, userInfo);\r\n                    } else {//获取用户信息失败\r\n                        dd.ui_manager.showTip('微信用户信息获取失败，请重新授权登录');\r\n                    }\r\n                } else {//授权过期需要重新授权\r\n                    dd.ui_manager.showTip('微信授权过期，请重新授权登录');\r\n                }\r\n            } catch (err) {\r\n                cc.log(err);\r\n                dd.ui_manager.showTip('微信请求异常，请重新授权登录');\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * 微信登录\r\n     * \r\n     * @returns \r\n     * @memberof LoginCanvas\r\n     */\r\n    click_btn_wx() {\r\n        dd.mp_manager.playButton();\r\n        if (!this.btn_wx.interactable) return;\r\n        if (dd.ui_manager.showLoading('正在拉取微信授权，请稍后')) {\r\n            setTimeout(() => {\r\n                dd.js_call_native.wxLogin();\r\n            }, 1000);\r\n        }\r\n    }\r\n    /**\r\n     * ws登录请求\r\n     * \r\n     * @param {Protocol} msgId 协议号\r\n     * @param {UserInfo} [info] 微信获取的数据对象\r\n     * @memberof LoginCanvas\r\n     */\r\n    wsLogin(msgId: Protocol, info?: UserInfo): void {\r\n        if (dd.ui_manager.showLoading()) {\r\n            let obj: any = {};\r\n            if (info) {\r\n                obj.uuid = info.unionid;\r\n                obj.headImg = info.headimgurl;\r\n                obj.nick = info.nickname;\r\n                obj.sex = info.sex;\r\n            } else {\r\n                obj.uuid = this.getGuestAccount();\r\n            }\r\n            dd.config.voiceState = dd.js_call_native.initVoice(obj.uuid, dd.config.voice_id, dd.config.voice_key);\r\n            if (dd.config.voiceState !== 0) {\r\n                dd.ui_manager.showTip('语音初始化失败,正在重试');\r\n            }\r\n            dd.ws_manager.sendMsg(\r\n                msgId,\r\n                JSON.stringify(obj),\r\n                (flag: number, content?: any) => {\r\n                    dd.ui_manager.hideLoading();\r\n                    if (flag === 0) {//登录服务器成功\r\n                        dd.ud_manager.mineData = content as UserData;\r\n                        dd.ws_manager.setLoginState(true);\r\n                        cc.director.loadScene('HomeScene');\r\n                    } else {//登录服务器失败\r\n                        dd.ui_manager.showTip(content);\r\n                    }\r\n                });\r\n        }\r\n    }\r\n    /**\r\n     * 游客登录\r\n     * \r\n     * @returns \r\n     * @memberof LoginCanvas\r\n     */\r\n    click_btn_yk() {\r\n        dd.mp_manager.playButton();\r\n        if (!this.btn_yk.interactable) return;\r\n        this.wsLogin(dd.protocol.ACCOUNT_LOGIN_TOURIST);\r\n    }\r\n    /**\r\n     * 获取uuid，第一次运行创建uuid\r\n     * \r\n     * @returns \r\n     * @memberof LoginCanvas\r\n     */\r\n    getGuestAccount(): string {\r\n        let db = cc.sys.localStorage;\r\n        let uuid = db.getItem('uuid');\r\n        if (uuid && uuid.length === 32) {\r\n            return uuid;\r\n        } else {\r\n            uuid = this.createUUID(32, 16);\r\n            db.setItem('uuid', uuid);\r\n            return uuid;\r\n        }\r\n    }\r\n    /**\r\n     * 创建UUID\r\n     * \r\n     * @param {number} len UUID长度\r\n     * @param {number} radix 输出的进制（2,8,10,16）\r\n     * @returns {string} 返回对应进制下制定长度的字符串\r\n     * @memberof LoginCanvas\r\n     */\r\n    createUUID(len: number, radix: number): string {\r\n        let chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');\r\n        let uuid = [], i;\r\n        radix = radix || chars.length;\r\n        if (len) {\r\n            for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random() * radix];\r\n        } else {\r\n            let r;\r\n            uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';\r\n            uuid[14] = '4';\r\n            for (i = 0; i < 36; i++) {\r\n                if (!uuid[i]) {\r\n                    r = 0 | Math.random() * 16;\r\n                    uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];\r\n                }\r\n            }\r\n        }\r\n        return uuid.join('');\r\n    }\r\n    /**\r\n     * 点击用户协议的复选框事件\r\n     * \r\n     * @memberof LoginCanvas\r\n     */\r\n    click_yhxy_toggle() {\r\n        dd.mp_manager.playButton();\r\n        this.btn_wx.interactable = this.checkToggle.isChecked ? true : false;\r\n        this.btn_yk.interactable = this.checkToggle.isChecked ? true : false;\r\n    }\r\n}\r\n"]}